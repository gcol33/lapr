<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Matching Workflows: From Data to Publication ‚Ä¢ couplr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Matching Workflows: From Data to Publication">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">couplr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/algorithms.html">Algorithm Details</a></li>
    <li><a class="dropdown-item" href="../articles/matching-workflows.html">Matching Workflows</a></li>
    <li><a class="dropdown-item" href="../articles/pixel-morphing.html">Pixel Morphing &amp; Scientific Applications</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="dropdown-item" href="../news/index.html">Version 1.0.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gcol33/couplr" aria-label="GitHub"><span class="fa fab fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Matching Workflows: From Data to Publication</h1>
                        <h4 data-toc-skip class="author">Gilles
Colling</h4>
            
            <h4 data-toc-skip class="date">2025-11-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/gcol33/couplr/blob/HEAD/vignettes/matching-workflows.Rmd" class="external-link"><code>vignettes/matching-workflows.Rmd</code></a></small>
      <div class="d-none name"><code>matching-workflows.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Matching is a fundamental technique for creating comparable groups in
observational studies. Unlike random assignment, observational data
often contain systematic differences between treatment and control
groups that confound causal inference. Matching addresses this by
pairing similar units based on observed characteristics, creating
‚Äúapples-to-apples‚Äù comparisons.</p>
<p>This vignette follows a <strong>complete workflow</strong> from raw
data to publication-ready results, using a realistic job training
evaluation as the running example. You‚Äôll learn to handle the full
pipeline: preprocessing, matching, assessment, and reporting.</p>
<div class="section level3">
<h3 id="who-this-vignette-is-for">Who This Vignette Is For<a class="anchor" aria-label="anchor" href="#who-this-vignette-is-for"></a>
</h3>
<p><strong>Audience</strong>: Researchers, epidemiologists, economists,
data scientists working with observational data</p>
<p><strong>Prerequisites</strong>:</p>
<ul>
<li>Familiarity with basic <code>couplr</code> usage
(<code><a href="../articles/getting-started.html">vignette("getting-started")</a></code>)</li>
<li>Understanding of causal inference concepts (treatment effects,
confounding)</li>
<li>Basic statistics (means, standard deviations, t-tests)</li>
</ul>
<p><strong>What You‚Äôll Learn</strong>:</p>
<ul>
<li>How to match treatment and control units with
<code><a href="../reference/match_couples.html">match_couples()</a></code>
</li>
<li>Automatic preprocessing: scaling, health checks, categorical
encoding</li>
<li>Assessing match quality with <code><a href="../reference/balance_diagnostics.html">balance_diagnostics()</a></code>
</li>
<li>When to use optimal vs greedy matching</li>
<li>Creating publication-ready balance tables</li>
</ul>
<p><strong>Time to complete</strong>: 30-45 minutes</p>
</div>
<div class="section level3">
<h3 id="documentation-roadmap">Documentation Roadmap<a class="anchor" aria-label="anchor" href="#documentation-roadmap"></a>
</h3>
<table class="table">
<colgroup>
<col width="34%">
<col width="24%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th>Vignette</th>
<th>Focus</th>
<th>Difficulty</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Getting Started</td>
<td>Basic LAP solving, API introduction</td>
<td>Beginner</td>
</tr>
<tr class="even">
<td>Algorithms</td>
<td>Mathematical foundations, solver selection</td>
<td>Intermediate</td>
</tr>
<tr class="odd">
<td><strong>Matching Workflows</strong></td>
<td>Production matching pipelines</td>
<td>Intermediate</td>
</tr>
<tr class="even">
<td>Pixel Morphing</td>
<td>Scientific applications, approximations</td>
<td>Advanced</td>
</tr>
</tbody>
</table>
<p><em>You are here: Matching Workflows</em></p>
</div>
<div class="section level3">
<h3 id="the-running-example-job-training-evaluation">The Running Example: Job Training Evaluation<a class="anchor" aria-label="anchor" href="#the-running-example-job-training-evaluation"></a>
</h3>
<p>Throughout this vignette, we evaluate a <strong>job training
program‚Äôs effect on earnings</strong>. The challenge: participants
self-selected into the program, so they differ systematically from
non-participants in age, education, and prior earnings. Without
matching, any earnings difference could be due to these baseline
differences rather than the program itself.</p>
<p><strong>Our goal</strong>: Create comparable treatment and control
groups, assess balance quality, and estimate the treatment effect
credibly.</p>
</div>
<div class="section level3">
<h3 id="key-features">Key Features<a class="anchor" aria-label="anchor" href="#key-features"></a>
</h3>
<ul>
<li>Automatic preprocessing with health checks and smart scaling</li>
<li>Optimal matching via linear assignment algorithms</li>
<li>Fast greedy matching for large datasets (n &gt; 5,000)</li>
<li>Blocking and stratification support</li>
<li>Comprehensive balance diagnostics</li>
<li>Publication-ready output tables</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="problem-definition">Problem Definition<a class="anchor" aria-label="anchor" href="#problem-definition"></a>
</h2>
<div class="section level3">
<h3 id="the-matching-problem">The Matching Problem<a class="anchor" aria-label="anchor" href="#the-matching-problem"></a>
</h3>
<p>Given two groups of units:</p>
<ul>
<li>
<strong>Left group</strong> (treatment, exposed, cases):
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>L</mi></msub><annotation encoding="application/x-tex">n_L</annotation></semantics></math>
units</li>
<li>
<strong>Right group</strong> (control, unexposed, controls):
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>R</mi></msub><annotation encoding="application/x-tex">n_R</annotation></semantics></math>
units</li>
</ul>
<p>Each unit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
has a covariate vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùê±</mi><mi>i</mi></msub><mo>‚àà</mo><msup><mi>‚Ñù</mi><mi>p</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{x}_i \in \mathbb{R}^p</annotation></semantics></math>
describing characteristics we want to balance (age, income, education,
etc.).</p>
<p><strong>Goal:</strong> Find one-to-one matches that minimize total
distance:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder><mi mathvariant="normal">min</mi><mi>œÄ</mi></munder><munderover><mo>‚àë</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>d</mi><mo stretchy="false" form="prefix">(</mo><msubsup><mi>ùê±</mi><mi>i</mi><mi>L</mi></msubsup><mo>,</mo><msubsup><mi>ùê±</mi><mrow><mi>œÄ</mi><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo stretchy="false" form="postfix">)</mo></mrow><mi>R</mi></msubsup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">
\min_{\pi} \sum_{i=1}^{n} d(\mathbf{x}_i^L, \mathbf{x}_{\pi(i)}^R)
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false" form="prefix">(</mo><mi>‚ãÖ</mi><mo>,</mo><mi>‚ãÖ</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">d(\cdot, \cdot)</annotation></semantics></math>
is a distance function (typically Euclidean or Mahalanobis) and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œÄ</mi><annotation encoding="application/x-tex">\pi</annotation></semantics></math>
is a matching assignment.</p>
</div>
<div class="section level3">
<h3 id="why-matching-matters">Why Matching Matters<a class="anchor" aria-label="anchor" href="#why-matching-matters"></a>
</h3>
<p><strong>Without matching:</strong> - Groups may differ systematically
on important covariates - Treatment effect estimates are confounded by
these differences - Statistical adjustments (regression) rely on
untestable assumptions</p>
<p><strong>With matching:</strong> - Create comparable groups that
differ primarily in treatment status - Balance covariates to reduce
confounding - Improve causal inference by mimicking randomized
experiments - Transparent, non-parametric preprocessing step</p>
</div>
<div class="section level3">
<h3 id="distance-metrics">Distance Metrics<a class="anchor" aria-label="anchor" href="#distance-metrics"></a>
</h3>
<p>The quality of matching depends on the distance metric:</p>
<p><strong>Euclidean distance</strong> (after scaling):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>ùê±</mi><mi>i</mi></msub><mo>,</mo><msub><mi>ùê±</mi><mi>j</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><msqrt><mrow><munderover><mo>‚àë</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>p</mi></munderover><mo stretchy="false" form="prefix">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><mo>‚àí</mo><msub><mi>x</mi><mrow><mi>j</mi><mi>k</mi></mrow></msub><msup><mo stretchy="false" form="postfix">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">
d(\mathbf{x}_i, \mathbf{x}_j) = \sqrt{\sum_{k=1}^{p} (x_{ik} - x_{jk})^2}
</annotation></semantics></math></p>
<p><strong>Mahalanobis distance</strong> (accounts for correlations):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false" form="prefix">(</mo><msub><mi>ùê±</mi><mi>i</mi></msub><mo>,</mo><msub><mi>ùê±</mi><mi>j</mi></msub><mo stretchy="false" form="postfix">)</mo><mo>=</mo><msqrt><mrow><mo stretchy="false" form="prefix">(</mo><msub><mi>ùê±</mi><mi>i</mi></msub><mo>‚àí</mo><msub><mi>ùê±</mi><mi>j</mi></msub><msup><mo stretchy="false" form="postfix">)</mo><mi>‚ä§</mi></msup><msup><mi mathvariant="normal">Œ£</mi><mrow><mi>‚àí</mi><mn>1</mn></mrow></msup><mo stretchy="false" form="prefix">(</mo><msub><mi>ùê±</mi><mi>i</mi></msub><mo>‚àí</mo><msub><mi>ùê±</mi><mi>j</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow></msqrt></mrow><annotation encoding="application/x-tex">
d(\mathbf{x}_i, \mathbf{x}_j) = \sqrt{(\mathbf{x}_i - \mathbf{x}_j)^\top \Sigma^{-1} (\mathbf{x}_i - \mathbf{x}_j)}
</annotation></semantics></math></p>
<p><strong>Propensity score distance</strong> (single dimension):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mo stretchy="false" form="prefix">|</mo><msub><mi>p</mi><mi>i</mi></msub><mo>‚àí</mo><msub><mi>p</mi><mi>j</mi></msub><mo stretchy="false" form="prefix">|</mo></mrow><annotation encoding="application/x-tex">
d(i, j) = |p_i - p_j|
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mi>P</mi><mo stretchy="false" form="prefix">(</mo><mtext mathvariant="normal">treatment</mtext><mo>‚à£</mo><msub><mi>ùê±</mi><mi>i</mi></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">p_i = P(\text{treatment} \mid \mathbf{x}_i)</annotation></semantics></math>
is the propensity score.</p>
<p><code>couplr</code> defaults to Euclidean distance with automatic
scaling, which works well for most applications.</p>
</div>
</div>
<div class="section level2">
<h2 id="basic-usage">Basic Usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<div class="section level3">
<h3 id="creating-a-matched-sample">Creating a Matched Sample<a class="anchor" aria-label="anchor" href="#creating-a-matched-sample"></a>
</h3>
<p>The simplest workflow uses <code><a href="../reference/match_couples.html">match_couples()</a></code> with
automatic preprocessing:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate observational data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n_left</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">n_right</span> <span class="op">&lt;-</span> <span class="fl">150</span></span>
<span></span>
<span><span class="co"># Treatment group (tends to be younger, higher income)</span></span>
<span><span class="va">left_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_left</span>,</span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_left</span>, mean <span class="op">=</span> <span class="fl">45</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_left</span>, mean <span class="op">=</span> <span class="fl">60000</span>, sd <span class="op">=</span> <span class="fl">15000</span><span class="op">)</span>,</span>
<span>  education <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HS"</span>, <span class="st">"BA"</span>, <span class="st">"MA"</span><span class="op">)</span>, <span class="va">n_left</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"treatment"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Control group (older, lower income on average)</span></span>
<span><span class="va">right_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_right</span>,</span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_right</span>, mean <span class="op">=</span> <span class="fl">52</span>, sd <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>  income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_right</span>, mean <span class="op">=</span> <span class="fl">50000</span>, sd <span class="op">=</span> <span class="fl">18000</span><span class="op">)</span>,</span>
<span>  education <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HS"</span>, <span class="st">"BA"</span>, <span class="st">"MA"</span><span class="op">)</span>, <span class="va">n_right</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  group <span class="op">=</span> <span class="st">"control"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Perform optimal matching</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  left <span class="op">=</span> <span class="va">left_data</span>,</span>
<span>  right <span class="op">=</span> <span class="va">right_data</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span><span class="op">)</span>,</span>
<span>  auto_scale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  return_diagnostics <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Auto-selected scaling method: standardize</span></span>
<span></span>
<span><span class="co"># View matched pairs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">pairs</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 √ó 5</span></span></span>
<span><span class="co">#&gt;   left_id right_id distance .age_diff .income_diff</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1       27         0.530   -<span style="color: #BB0000;">5.68</span>           <span style="text-decoration: underline;">2</span>942.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2       37         0.299    3.33            980.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 3       15         0.038<span style="text-decoration: underline;">2</span>  -<span style="color: #BB0000;">0.251</span>          -<span style="color: #BB0000;">512.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 4       11         0.691   -<span style="color: #BB0000;">7.19</span>           <span style="text-decoration: underline;">4</span>587.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 5       73         0.425   -<span style="color: #BB0000;">4.48</span>           <span style="text-decoration: underline;">2</span>583.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 6       131        0.133    0.001<span style="text-decoration: underline;">87</span>       -<span style="color: #BB0000; text-decoration: underline;">2</span><span style="color: #BB0000;">186.</span></span></span>
<span></span>
<span><span class="co"># Summary statistics</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">info</span></span>
<span><span class="co">#&gt; $solver</span></span>
<span><span class="co">#&gt; [1] "auction_scaled"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $n_matched</span></span>
<span><span class="co">#&gt; [1] 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $total_distance</span></span>
<span><span class="co">#&gt; [1] 33.77392</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $method</span></span>
<span><span class="co">#&gt; [1] "lap"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $distance_metric</span></span>
<span><span class="co">#&gt; [1] "euclidean"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $scaled</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $n_left</span></span>
<span><span class="co">#&gt; [1] 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $n_right</span></span>
<span><span class="co">#&gt; [1] 150</span></span></code></pre></div>
<p>The result contains:</p>
<ul>
<li>
<code>pairs</code>: Matched pairs with IDs and distances</li>
<li>
<code>info</code>: Matching method, counts, total distance</li>
<li>
<code>left_unmatched</code>, <code>right_unmatched</code>: Units
without matches</li>
<li>
<code>cost_matrix</code>: Full distance matrix (if
<code>return_diagnostics = TRUE</code>)</li>
</ul>
</div>
<div class="section level3">
<h3 id="understanding-the-output">Understanding the Output<a class="anchor" aria-label="anchor" href="#understanding-the-output"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># How many matched?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matched pairs:"</span>, <span class="va">result</span><span class="op">$</span><span class="va">info</span><span class="op">$</span><span class="va">n_matched</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Matched pairs: 100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Unmatched left:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">left_unmatched</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Unmatched left:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Unmatched right:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">right_unmatched</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Unmatched right:</span></span>
<span></span>
<span><span class="co"># Distribution of match distances</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span><span class="co">#&gt; 0.002044 0.139855 0.249548 0.337739 0.466174 1.939711</span></span>
<span></span>
<span><span class="co"># Visualize match quality</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">pairs</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">distance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">30</span>, fill <span class="op">=</span> <span class="st">"steelblue"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Distribution of Match Distances"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Euclidean Distance (scaled)"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Count"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="matching-workflows_files/figure-html/inspect-output-1.png" class="r-plt" alt="Histogram showing the distribution of match distances, with most matches having low distances indicating good match quality" width="672"></p>
<p><strong>Interpretation:</strong></p>
<ul>
<li>Lower distances indicate better matches (more similar units)</li>
<li>Median distance provides typical match quality</li>
<li>Large distances suggest poor matches (consider caliper
constraints)</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="automatic-preprocessing">Automatic Preprocessing<a class="anchor" aria-label="anchor" href="#automatic-preprocessing"></a>
</h2>
<div class="section level3">
<h3 id="why-preprocessing-matters">Why Preprocessing Matters<a class="anchor" aria-label="anchor" href="#why-preprocessing-matters"></a>
</h3>
<p>Raw covariates often have:</p>
<ul>
<li>
<strong>Different scales</strong>: Age in years (20-80), income in
dollars (20,000-200,000)</li>
<li>
<strong>Different units</strong>: Continuous (age), categorical
(education), binary (smoker)</li>
<li>
<strong>Data quality issues</strong>: Missing values, constant
variables, extreme outliers</li>
</ul>
<p>Without preprocessing, high-variance variables dominate distance
calculations.</p>
</div>
<div class="section level3">
<h3 id="smart-scaling-with-auto_scale-true">Smart Scaling with <code>auto_scale = TRUE</code><a class="anchor" aria-label="anchor" href="#smart-scaling-with-auto_scale-true"></a>
</h3>
<p>When <code>auto_scale = TRUE</code>, <code><a href="../reference/match_couples.html">match_couples()</a></code>
automatically:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Detects problematic variables</strong>
<ul>
<li>Constant variables (SD = 0) ‚Üí excluded with warning</li>
<li>High missingness (&gt;50%) ‚Üí warned</li>
<li>Extreme skewness (|skew| &gt; 2) ‚Üí informed</li>
</ul>
</li>
<li>
<strong>Applies appropriate scaling</strong>
<ul>
<li>Continuous variables ‚Üí scaled by selected method</li>
<li>Binary variables (0/1) ‚Üí used as-is</li>
<li>Categorical ‚Üí converted to numeric if ordered</li>
</ul>
</li>
<li>
<strong>Handles categorical variables</strong>
<ul>
<li>Unordered factors ‚Üí converted to binary indicators</li>
<li>Ordered factors ‚Üí converted to numeric ranks</li>
</ul>
</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create data with scaling challenges</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">challenging_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,</span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span>,                    <span class="co"># Years (reasonable scale)</span></span>
<span>  income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">60000</span>, <span class="fl">20000</span><span class="op">)</span>,           <span class="co"># Dollars (large scale)</span></span>
<span>  bmi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">25</span>, <span class="fl">5</span><span class="op">)</span>,                     <span class="co"># Ratio (small scale)</span></span>
<span>  smoker <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,   <span class="co"># Binary</span></span>
<span>  education <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HS"</span>, <span class="st">"BA"</span>, <span class="st">"MA"</span>, <span class="st">"PhD"</span><span class="op">)</span>, <span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    ordered <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HS"</span>, <span class="st">"BA"</span>, <span class="st">"MA"</span>, <span class="st">"PhD"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">left_chal</span> <span class="op">&lt;-</span> <span class="va">challenging_data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">25</span>, <span class="op">]</span></span>
<span><span class="va">right_chal</span> <span class="op">&lt;-</span> <span class="va">challenging_data</span><span class="op">[</span><span class="fl">26</span><span class="op">:</span><span class="fl">50</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Match WITHOUT auto-scaling (income dominates)</span></span>
<span><span class="va">result_no_scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">left_chal</span>, <span class="va">right_chal</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span>, <span class="st">"bmi"</span><span class="op">)</span>,</span>
<span>  auto_scale <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Match WITH auto-scaling (all variables contribute)</span></span>
<span><span class="va">result_scaled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">left_chal</span>, <span class="va">right_chal</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span>, <span class="st">"bmi"</span><span class="op">)</span>,</span>
<span>  auto_scale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  scale <span class="op">=</span> <span class="st">"robust"</span>  <span class="co"># Median/MAD scaling (robust to outliers)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare match quality</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Without scaling - mean distance:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result_no_scale</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Without scaling - mean distance: 3572.096</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"With scaling - mean distance:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result_scaled</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; With scaling - mean distance: 0.9784372</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="scaling-methods">Scaling Methods<a class="anchor" aria-label="anchor" href="#scaling-methods"></a>
</h3>
<p>Three scaling strategies available via <code>scale</code>
parameter:</p>
<p><strong>1. Robust scaling</strong> (<code>scale = "robust"</code>,
default):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mtext mathvariant="normal">scaled</mtext></msub><mo>=</mo><mfrac><mrow><mi>x</mi><mo>‚àí</mo><mtext mathvariant="normal">median</mtext><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><mtext mathvariant="normal">MAD</mtext><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
x_{\text{scaled}} = \frac{x - \text{median}(x)}{\text{MAD}(x)}
</annotation></semantics></math></p>
<ul>
<li>Uses median and median absolute deviation (MAD)</li>
<li>Resistant to outliers and skewness</li>
<li>Best for: Real-world data with potential outliers</li>
</ul>
<p><strong>2. Standardization</strong>
(<code>scale = "standardize"</code>):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mtext mathvariant="normal">scaled</mtext></msub><mo>=</mo><mfrac><mrow><mi>x</mi><mo>‚àí</mo><mtext mathvariant="normal">mean</mtext><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><mtext mathvariant="normal">SD</mtext><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
x_{\text{scaled}} = \frac{x - \text{mean}(x)}{\text{SD}(x)}
</annotation></semantics></math></p>
<ul>
<li>Classical z-score normalization</li>
<li>Assumes approximate normality</li>
<li>Best for: Clean, normally-distributed data</li>
</ul>
<p><strong>3. Range scaling</strong> (<code>scale = "range"</code>):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mtext mathvariant="normal">scaled</mtext></msub><mo>=</mo><mfrac><mrow><mi>x</mi><mo>‚àí</mo><mrow><mi mathvariant="normal">min</mi><mo>‚Å°</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><mrow><mi mathvariant="normal">max</mi><mo>‚Å°</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo><mo>‚àí</mo><mrow><mi mathvariant="normal">min</mi><mo>‚Å°</mo></mrow><mo stretchy="false" form="prefix">(</mo><mi>x</mi><mo stretchy="false" form="postfix">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
x_{\text{scaled}} = \frac{x - \min(x)}{\max(x) - \min(x)}
</annotation></semantics></math></p>
<ul>
<li>Scales to [0, 1] range</li>
<li>Preserves exact relationships</li>
<li>Best for: Bounded variables, visualization</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate scaling methods</span></span>
<span><span class="va">demo_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">25</span>, <span class="fl">30</span>, <span class="fl">100</span><span class="op">)</span>  <span class="co"># Contains outlier (100)</span></span>
<span></span>
<span><span class="co"># Function to show scaling</span></span>
<span><span class="va">show_scaling</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">method</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">left_demo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, var <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">right_demo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, var <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>    <span class="va">left_demo</span>, <span class="va">right_demo</span>,</span>
<span>    vars <span class="op">=</span> <span class="st">"var"</span>,</span>
<span>    auto_scale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    scale <span class="op">=</span> <span class="va">method</span>,</span>
<span>    return_diagnostics <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract scaled values from cost matrix</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">method</span>, <span class="st">"scaling:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Original:"</span>, <span class="va">x</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Distance matrix diagonal:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">cost_matrix</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">show_scaling</span><span class="op">(</span><span class="va">demo_var</span>, <span class="st">"robust"</span><span class="op">)</span></span>
<span><span class="co">#&gt; robust scaling:</span></span>
<span><span class="co">#&gt;   Original: 10 20 25 30 100 </span></span>
<span><span class="co">#&gt;   Distance matrix diagonal: NA NA</span></span>
<span><span class="fu">show_scaling</span><span class="op">(</span><span class="va">demo_var</span>, <span class="st">"standardize"</span><span class="op">)</span></span>
<span><span class="co">#&gt; standardize scaling:</span></span>
<span><span class="co">#&gt;   Original: 10 20 25 30 100 </span></span>
<span><span class="co">#&gt;   Distance matrix diagonal: NA NA</span></span>
<span><span class="fu">show_scaling</span><span class="op">(</span><span class="va">demo_var</span>, <span class="st">"range"</span><span class="op">)</span></span>
<span><span class="co">#&gt; range scaling:</span></span>
<span><span class="co">#&gt;   Original: 10 20 25 30 100 </span></span>
<span><span class="co">#&gt;   Distance matrix diagonal: NA NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="health-checks-and-warnings">Health Checks and Warnings<a class="anchor" aria-label="anchor" href="#health-checks-and-warnings"></a>
</h3>
<p>The preprocessing system provides informative diagnostics:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create data with issues</span></span>
<span><span class="va">problematic_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  constant_var <span class="op">=</span> <span class="fl">5</span>,                           <span class="co"># No variation - will warn</span></span>
<span>  mostly_missing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span>,  <span class="co"># &gt;50% missing</span></span>
<span>  extreme_skew <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">100</span>, rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>       <span class="co"># Very skewed</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Attempt matching - will show warnings</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">problematic_data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>, <span class="op">]</span>,</span>
<span>  <span class="va">problematic_data</span><span class="op">[</span><span class="fl">51</span><span class="op">:</span><span class="fl">100</span>, <span class="op">]</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"constant_var"</span>, <span class="st">"mostly_missing"</span>, <span class="st">"extreme_skew"</span><span class="op">)</span>,</span>
<span>  auto_scale <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Warning messages will indicate:</span></span>
<span><span class="co"># - "constant_var excluded (SD = 0)"</span></span>
<span><span class="co"># - "mostly_missing has 80% missing values"</span></span>
<span><span class="co"># - "extreme_skew has high skewness (3.2)"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="optimal-vs-greedy-matching">Optimal vs Greedy Matching<a class="anchor" aria-label="anchor" href="#optimal-vs-greedy-matching"></a>
</h2>
<p>For large datasets (n &gt; 5,000), optimal matching becomes
computationally expensive. <code>couplr</code> provides fast greedy
alternatives.</p>
<div class="section level3">
<h3 id="when-to-use-each-approach">When to Use Each Approach<a class="anchor" aria-label="anchor" href="#when-to-use-each-approach"></a>
</h3>
<p><strong>Optimal matching</strong>
(<code>method = "optimal"</code>):</p>
<ul>
<li>Minimizes total distance (globally optimal solution)</li>
<li>Uses linear assignment algorithms
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false" form="prefix">(</mo><msup><mi>n</mi><mn>3</mn></msup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">O(n^3)</annotation></semantics></math>
complexity)</li>
<li>Suitable for: n &lt; 5,000, when optimality is critical</li>
<li>Typical runtime: &lt;1 second for n=1,000, ~10 seconds for
n=3,000</li>
</ul>
<p><strong>Greedy matching</strong>
(<code>method = "greedy"</code>):</p>
<ul>
<li>Fast approximation (10-100x faster)</li>
<li>Three strategies: sorted, row_best, pq</li>
<li>Suitable for: n &gt; 5,000, exploratory analysis, when speed
matters</li>
<li>Typical runtime: &lt;1 second for n=10,000</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create moderately large dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">789</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">large_left</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>  x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>  x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>  x3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">large_right</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>  x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>  x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>  x3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Optimal matching</span></span>
<span><span class="va">time_optimal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_optimal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>    <span class="va">large_left</span>, <span class="va">large_right</span>,</span>
<span>    vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"hungarian"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Greedy matching (row_best strategy)</span></span>
<span><span class="va">time_greedy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">result_greedy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/greedy_couples.html">greedy_couples</a></span><span class="op">(</span></span>
<span>    <span class="va">large_left</span>, <span class="va">large_right</span>,</span>
<span>    vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span><span class="op">)</span>,</span>
<span>    strategy <span class="op">=</span> <span class="st">"row_best"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Optimal matching:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Optimal matching:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">time_optimal</span><span class="op">[</span><span class="st">"elapsed"</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Time: 22.16 seconds</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean distance:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result_optimal</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean distance: 0.3368</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Greedy matching:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Greedy matching:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Time:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">time_greedy</span><span class="op">[</span><span class="st">"elapsed"</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Time: 0.91 seconds</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean distance:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result_greedy</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean distance: 0.4667</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Speedup:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">time_optimal</span><span class="op">[</span><span class="st">"elapsed"</span><span class="op">]</span> <span class="op">/</span> <span class="va">time_greedy</span><span class="op">[</span><span class="st">"elapsed"</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"x\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Speedup: 24.4 x</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="greedy-strategies">Greedy Strategies<a class="anchor" aria-label="anchor" href="#greedy-strategies"></a>
</h3>
<p>Three greedy strategies available via
<code><a href="../reference/greedy_couples.html">greedy_couples()</a></code>:</p>
<p><strong>1. Sorted</strong> (<code>strategy = "sorted"</code>):</p>
<ul>
<li>Sort all possible pairs by distance</li>
<li>Assign greedily from best to worst</li>
<li>Best quality among greedy methods</li>
<li>Slowest greedy option (still much faster than optimal)</li>
</ul>
<pre><code>Algorithm:
1. Compute all n_L √ó n_R distances
2. Sort pairs by distance (ascending)
3. For each pair in sorted order:
   - If both units unmatched, assign them
4. Stop when no more matches possible</code></pre>
<p><strong>2. Row-best</strong> (<code>strategy = "row_best"</code>,
default):</p>
<ul>
<li>For each left unit, find best available right unit</li>
<li>Process left units in order</li>
<li>Fast and simple</li>
<li>Medium quality</li>
</ul>
<pre><code>Algorithm:
1. For i = 1 to n_L:
   - Find unmatched right unit j with minimum distance to i
   - Assign (i, j)
2. Return all assignments</code></pre>
<p><strong>3. Priority queue</strong>
(<code>strategy = "pq"</code>):</p>
<ul>
<li>Maintains priority queue of potential matches</li>
<li>Updates dynamically as assignments made</li>
<li>Best for very large problems</li>
<li>Fastest option</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare greedy strategies on same data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span></span>
<span><span class="va">test_left</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">200</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test_right</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">200</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">strategies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sorted"</span>, <span class="st">"row_best"</span>, <span class="st">"pq"</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">strat</span> <span class="kw">in</span> <span class="va">strategies</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/greedy_couples.html">greedy_couples</a></span><span class="op">(</span></span>
<span>      <span class="va">test_left</span>, <span class="va">test_right</span>,</span>
<span>      vars <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>      strategy <span class="op">=</span> <span class="va">strat</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">results</span><span class="op">[[</span><span class="va">strat</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    time <span class="op">=</span> <span class="va">time</span><span class="op">[</span><span class="st">"elapsed"</span><span class="op">]</span>,</span>
<span>    mean_dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>,</span>
<span>    total_dist <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">info</span><span class="op">$</span><span class="va">total_distance</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Display comparison</span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    strategy <span class="op">=</span> <span class="va">s</span>,</span>
<span>    time_sec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">results</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">time</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>    mean_distance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">results</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mean_dist</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>    total_distance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">results</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">total_dist</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">comparison</span><span class="op">)</span></span>
<span><span class="co">#&gt;          strategy time_sec mean_distance total_distance</span></span>
<span><span class="co">#&gt; elapsed    sorted     0.05        0.0912          18.24</span></span>
<span><span class="co">#&gt; elapsed1 row_best     0.05        0.0968          19.36</span></span>
<span><span class="co">#&gt; elapsed2       pq     0.04        0.0912          18.24</span></span></code></pre></div>
<p><strong>Recommendation:</strong></p>
<ul>
<li>Default to <code>strategy = "row_best"</code> for good speed/quality
balance</li>
<li>Use <code>strategy = "sorted"</code> when quality is important but
optimal is too slow</li>
<li>Use <code>strategy = "pq"</code> for n &gt; 10,000</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="caliper-constraints">Caliper Constraints<a class="anchor" aria-label="anchor" href="#caliper-constraints"></a>
</h2>
<p>Calipers impose maximum allowable match distances to ensure minimum
quality.</p>
<div class="section level3">
<h3 id="why-use-calipers">Why Use Calipers<a class="anchor" aria-label="anchor" href="#why-use-calipers"></a>
</h3>
<p>Without calipers, optimal matching may pair very dissimilar units
just to maximize the number of matches. Calipers prevent this by:</p>
<ul>
<li>Setting a distance threshold beyond which matches are forbidden</li>
<li>Reducing the number of matches to improve average quality</li>
<li>Implementing the ‚Äúcommon support‚Äù requirement in propensity score
matching</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create data where some units are far apart</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">202</span><span class="op">)</span></span>
<span><span class="va">left_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,</span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">40</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span>, mean <span class="op">=</span> <span class="fl">5</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Some outliers</span></span>
<span><span class="op">)</span></span>
<span><span class="va">right_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,</span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">50</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Match without caliper - pairs everything</span></span>
<span><span class="va">result_no_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">left_cal</span>, <span class="va">right_cal</span>,</span>
<span>  vars <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  auto_scale <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Match with caliper - excludes poor matches</span></span>
<span><span class="va">result_with_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">left_cal</span>, <span class="va">right_cal</span>,</span>
<span>  vars <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  max_distance <span class="op">=</span> <span class="fl">1.5</span>,  <span class="co"># Caliper: max distance = 1.5</span></span>
<span>  auto_scale <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Without caliper:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Without caliper:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Matched:"</span>, <span class="va">result_no_cal</span><span class="op">$</span><span class="va">info</span><span class="op">$</span><span class="va">n_matched</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Matched: 50</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean distance:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result_no_cal</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean distance: 1.129</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Max distance:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">result_no_cal</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Max distance: 5.453</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"With caliper (1.5):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; With caliper (1.5):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Matched:"</span>, <span class="va">result_with_cal</span><span class="op">$</span><span class="va">info</span><span class="op">$</span><span class="va">n_matched</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Matched: 40</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean distance:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">result_with_cal</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean distance: 0.143</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Max distance:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">result_with_cal</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Max distance: 0.763</span></span>
<span></span>
<span><span class="co"># Visualize caliper effect</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">result_no_cal</span><span class="op">$</span><span class="va">pairs</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">distance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"No caliper"</span><span class="op">)</span>, bins <span class="op">=</span> <span class="fl">30</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">result_with_cal</span><span class="op">$</span><span class="va">pairs</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"With caliper"</span><span class="op">)</span>,</span>
<span>    bins <span class="op">=</span> <span class="fl">30</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1.5</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Caliper Effect on Match Distances"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Distance"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Count"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Condition"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="matching-workflows_files/figure-html/calipers-1.png" class="r-plt" alt="Overlapping histograms comparing match distances with and without caliper constraint, showing the caliper excludes distant matches" width="672"></p>
</div>
<div class="section level3">
<h3 id="choosing-caliper-width">Choosing Caliper Width<a class="anchor" aria-label="anchor" href="#choosing-caliper-width"></a>
</h3>
<p>Common approaches:</p>
<p><strong>1. Standard deviation rule</strong>: Caliper = 0.1 to 0.25
pooled SD</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate pooled SD</span></span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">left_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span>,</span>
<span>  <span class="va">right_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pooled_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">combined</span><span class="op">$</span><span class="va">age</span><span class="op">)</span>  <span class="co"># For single variable</span></span>
<span><span class="va">caliper_width</span> <span class="op">&lt;-</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">pooled_sd</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">left_data</span>, <span class="va">right_data</span>,</span>
<span>  vars <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  max_distance <span class="op">=</span> <span class="va">caliper_width</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>2. Propensity score rule</strong>: 0.1 to 0.25 SD of
propensity score logit</p>
<p><strong>3. Empirical rule</strong>: Examine distance distribution,
exclude extreme tail</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit all matches first</span></span>
<span><span class="va">all_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span><span class="va">left_cal</span>, <span class="va">right_cal</span>, vars <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Choose caliper at 90th percentile</span></span>
<span><span class="va">caliper_90</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">all_matches</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">distance</span>, <span class="fl">0.90</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Refit with caliper</span></span>
<span><span class="va">refined_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">left_cal</span>, <span class="va">right_cal</span>,</span>
<span>  vars <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  max_distance <span class="op">=</span> <span class="va">caliper_90</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"90th percentile caliper:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">caliper_90</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 90th percentile caliper: 4.532</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matches retained:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">refined_matches</span><span class="op">$</span><span class="va">info</span><span class="op">$</span><span class="va">n_matched</span> <span class="op">/</span> <span class="va">all_matches</span><span class="op">$</span><span class="va">info</span><span class="op">$</span><span class="va">n_matched</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Matches retained: 100 %</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="blocking-and-stratification">Blocking and Stratification<a class="anchor" aria-label="anchor" href="#blocking-and-stratification"></a>
</h2>
<p>Blocking (exact matching on key variables) combined with distance
matching on remaining covariates is a powerful strategy.</p>
<div class="section level3">
<h3 id="why-use-blocking">Why Use Blocking<a class="anchor" aria-label="anchor" href="#why-use-blocking"></a>
</h3>
<p><strong>Benefits:</strong></p>
<ul>
<li>Ensures exact balance on critical variables (site, gender, age
category)</li>
<li>Reduces problem size (smaller within-block matching problems)</li>
<li>Prevents poor cross-block matches</li>
<li>Transparent and interpretable</li>
</ul>
<p><strong>When to use:</strong></p>
<ul>
<li>Strong domain knowledge about important stratification
variables</li>
<li>Variables that absolutely must be balanced (e.g., study site in
multi-center trials)</li>
<li>Large datasets where blocking reduces computational burden</li>
</ul>
</div>
<div class="section level3">
<h3 id="exact-blocking-with-matchmaker">Exact Blocking with <code>matchmaker()</code><a class="anchor" aria-label="anchor" href="#exact-blocking-with-matchmaker"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create multi-site data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">303</span><span class="op">)</span></span>
<span><span class="va">multi_site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>    site <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">55000</span>, <span class="fl">15000</span><span class="op">)</span>,</span>
<span>    group <span class="op">=</span> <span class="st">"treatment"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">101</span><span class="op">:</span><span class="fl">250</span>,</span>
<span>    site <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>, <span class="fl">150</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">55000</span>, <span class="fl">15000</span><span class="op">)</span>,</span>
<span>    group <span class="op">=</span> <span class="st">"control"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">left_site</span> <span class="op">&lt;-</span> <span class="va">multi_site</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="st">"treatment"</span><span class="op">)</span></span>
<span><span class="va">right_site</span> <span class="op">&lt;-</span> <span class="va">multi_site</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="st">"control"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create exact blocks by site</span></span>
<span><span class="va">blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchmaker.html">matchmaker</a></span><span class="op">(</span></span>
<span>  left <span class="op">=</span> <span class="va">left_site</span>,</span>
<span>  right <span class="op">=</span> <span class="va">right_site</span>,</span>
<span>  block_type <span class="op">=</span> <span class="st">"group"</span>,</span>
<span>  block_by <span class="op">=</span> <span class="st">"site"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Blocking structure:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Blocking structure:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">$</span><span class="va">block_summary</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 √ó 3</span></span></span>
<span><span class="co">#&gt;   block_id n_left n_right</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> A            36      58</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> B            26      42</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> C            38      50</span></span>
<span></span>
<span><span class="co"># Match within blocks</span></span>
<span><span class="va">result_blocked</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  left <span class="op">=</span> <span class="va">blocks</span><span class="op">$</span><span class="va">left</span>,</span>
<span>  right <span class="op">=</span> <span class="va">blocks</span><span class="op">$</span><span class="va">right</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span><span class="op">)</span>,</span>
<span>  block_id <span class="op">=</span> <span class="st">"block_id"</span>,  <span class="co"># Use block IDs from matchmaker</span></span>
<span>  auto_scale <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Auto-selected scaling method: standardize</span></span>
<span></span>
<span><span class="co"># Verify exact site balance</span></span>
<span><span class="va">result_blocked</span><span class="op">$</span><span class="va">pairs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>left_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">left_id</span><span class="op">)</span>, right_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">right_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">left_site</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">site</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left_id"</span> <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">right_site</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">site</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"right_id"</span> <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"_left"</span>, <span class="st">"_right"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">site_left</span>, <span class="va">site_right</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 √ó 3</span></span></span>
<span><span class="co">#&gt;   site_left site_right     n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> A         A             36</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> B         B             26</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> C         C             38</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cluster-based-blocking">Cluster-Based Blocking<a class="anchor" aria-label="anchor" href="#cluster-based-blocking"></a>
</h3>
<p>For continuous variables, use k-means clustering to create
blocks:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create blocks based on age groups (data-driven)</span></span>
<span><span class="va">cluster_blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchmaker.html">matchmaker</a></span><span class="op">(</span></span>
<span>  left <span class="op">=</span> <span class="va">left_site</span>,</span>
<span>  right <span class="op">=</span> <span class="va">right_site</span>,</span>
<span>  block_type <span class="op">=</span> <span class="st">"cluster"</span>,</span>
<span>  block_vars <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  n_blocks <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cluster-based blocks:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Cluster-based blocks:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">cluster_blocks</span><span class="op">$</span><span class="va">block_summary</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 √ó 4</span></span></span>
<span><span class="co">#&gt;   block_id  n_left n_right mean_age</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> cluster_1     37      56     61.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> cluster_2     41      65     48.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> cluster_3     22      29     37.9</span></span>
<span></span>
<span><span class="co"># Match within clusters</span></span>
<span><span class="va">result_clustered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  left <span class="op">=</span> <span class="va">cluster_blocks</span><span class="op">$</span><span class="va">left</span>,</span>
<span>  right <span class="op">=</span> <span class="va">cluster_blocks</span><span class="op">$</span><span class="va">right</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span><span class="op">)</span>,</span>
<span>  block_id <span class="op">=</span> <span class="st">"block_id"</span>,</span>
<span>  auto_scale <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Auto-selected scaling method: standardize</span></span>
<span></span>
<span><span class="co"># Show age distribution by cluster</span></span>
<span><span class="va">cluster_blocks</span><span class="op">$</span><span class="va">left</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">block_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>,</span>
<span>    sd_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 √ó 4</span></span></span>
<span><span class="co">#&gt;   block_id      n mean_age sd_age</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> cluster_1    37     61.2   4.59</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> cluster_2    41     48.4   3.27</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> cluster_3    22     37.9   4.42</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="balance-diagnostics">Balance Diagnostics<a class="anchor" aria-label="anchor" href="#balance-diagnostics"></a>
</h2>
<p>After matching, assess balance quality using
<code><a href="../reference/balance_diagnostics.html">balance_diagnostics()</a></code>.</p>
<div class="section level3">
<h3 id="key-balance-metrics">Key Balance Metrics<a class="anchor" aria-label="anchor" href="#key-balance-metrics"></a>
</h3>
<p><strong>1. Standardized differences:</strong>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Std Diff</mtext><mo>=</mo><mfrac><mrow><msub><mover><mi>x</mi><mo accent="true">‚Äæ</mo></mover><mtext mathvariant="normal">left</mtext></msub><mo>‚àí</mo><msub><mover><mi>x</mi><mo accent="true">‚Äæ</mo></mover><mtext mathvariant="normal">right</mtext></msub></mrow><msqrt><mrow><mo stretchy="false" form="prefix">(</mo><msubsup><mi>s</mi><mtext mathvariant="normal">left</mtext><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>s</mi><mtext mathvariant="normal">right</mtext><mn>2</mn></msubsup><mo stretchy="false" form="postfix">)</mo><mi>/</mi><mn>2</mn></mrow></msqrt></mfrac></mrow><annotation encoding="application/x-tex">
\text{Std Diff} = \frac{\bar{x}_{\text{left}} - \bar{x}_{\text{right}}}{\sqrt{(s_{\text{left}}^2 + s_{\text{right}}^2) / 2}}
</annotation></semantics></math></p>
<p><strong>Thresholds:</strong> - &lt; 0.1: Excellent balance - 0.1 -
0.25: Good balance - 0.25 - 0.5: Acceptable (may need further
adjustment) - &gt; 0.5: Poor balance (reconsider matching strategy)</p>
<p><strong>2. Variance ratios:</strong>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">VR</mtext><mo>=</mo><mfrac><msubsup><mi>s</mi><mtext mathvariant="normal">left</mtext><mn>2</mn></msubsup><msubsup><mi>s</mi><mtext mathvariant="normal">right</mtext><mn>2</mn></msubsup></mfrac></mrow><annotation encoding="application/x-tex">
\text{VR} = \frac{s_{\text{left}}^2}{s_{\text{right}}^2}
</annotation></semantics></math></p>
<p><strong>Interpretation:</strong> - Close to 1.0: Similar variability
(good) - &lt; 0.5 or &gt; 2.0: Concerning imbalance in spread</p>
<p><strong>3. Kolmogorov-Smirnov tests:</strong></p>
<ul>
<li>Non-parametric test for distributional differences</li>
<li>Sensitive to differences beyond mean/variance</li>
<li>P-value &gt; 0.05 suggests similar distributions</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform matching</span></span>
<span><span class="va">match_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  left <span class="op">=</span> <span class="va">left_data</span>,</span>
<span>  right <span class="op">=</span> <span class="va">right_data</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span><span class="op">)</span>,</span>
<span>  auto_scale <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Auto-selected scaling method: standardize</span></span>
<span></span>
<span><span class="co"># Get matched samples</span></span>
<span><span class="va">matched_left</span> <span class="op">&lt;-</span> <span class="va">left_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">match_result</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">left_id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">matched_right</span> <span class="op">&lt;-</span> <span class="va">right_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">match_result</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">right_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute balance diagnostics</span></span>
<span><span class="va">balance</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/balance_diagnostics.html">balance_diagnostics</a></span><span class="op">(</span></span>
<span>  result <span class="op">=</span> <span class="va">match_result</span>,</span>
<span>  left <span class="op">=</span> <span class="va">left_data</span>,</span>
<span>  right <span class="op">=</span> <span class="va">right_data</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print balance summary</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">balance</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Balance Diagnostics for Matched Pairs</span></span>
<span><span class="co">#&gt; ======================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matching Summary:</span></span>
<span><span class="co">#&gt;   Method: lap</span></span>
<span><span class="co">#&gt;   Matched pairs: 100</span></span>
<span><span class="co">#&gt;   Unmatched left: 0 (of 100)</span></span>
<span><span class="co">#&gt;   Unmatched right: 50 (of 150)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable-level Balance:</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 √ó 7</span></span></span>
<span><span class="co">#&gt;   Variable `Mean Left` `Mean Right` `Mean Diff` `Std Diff` `Var Ratio` `KS Stat`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> age             45.9         47.3       -<span style="color: #BB0000;">1.43</span>     -<span style="color: #BB0000;">0.148</span>       0.891      0.18</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> income       <span style="text-decoration: underline;">58</span>387.       <span style="text-decoration: underline;">56</span>118.      <span style="text-decoration: underline;">2</span>269.        0.155       0.982      0.09</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall Balance:</span></span>
<span><span class="co">#&gt;   Mean |Std Diff|: 0.151 (Good)</span></span>
<span><span class="co">#&gt;   Max |Std Diff|: 0.155</span></span>
<span><span class="co">#&gt;   Vars with |Std Diff| &gt; 0.25: 0.0%</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Balance Interpretation:</span></span>
<span><span class="co">#&gt;   |Std Diff| &lt; 0.10: Excellent balance</span></span>
<span><span class="co">#&gt;   |Std Diff| 0.10-0.25: Good balance</span></span>
<span><span class="co">#&gt;   |Std Diff| 0.25-0.50: Acceptable balance</span></span>
<span><span class="co">#&gt;   |Std Diff| &gt; 0.50: Poor balance</span></span>
<span></span>
<span><span class="co"># Extract balance table for reporting</span></span>
<span><span class="fu"><a href="../reference/balance_table.html">balance_table</a></span><span class="op">(</span><span class="va">balance</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 √ó 7</span></span></span>
<span><span class="co">#&gt;   Variable `Mean Left` `Mean Right` `Mean Diff` `Std Diff` `Var Ratio` `KS Stat`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> age             45.9         47.3       -<span style="color: #BB0000;">1.43</span>     -<span style="color: #BB0000;">0.148</span>       0.891      0.18</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> income       <span style="text-decoration: underline;">58</span>387.       <span style="text-decoration: underline;">56</span>118.      <span style="text-decoration: underline;">2</span>269.        0.155       0.982      0.09</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="how-to-interpret-balance-results">How to Interpret Balance Results<a class="anchor" aria-label="anchor" href="#how-to-interpret-balance-results"></a>
</h3>
<p>The balance diagnostics output tells you whether your match
succeeded. Here‚Äôs how to read it:</p>
<pre><code>Balance Diagnostics
-------------------
Variables: age, income

Variable Statistics:
  variable mean_left mean_right std_diff var_ratio ks_stat ks_p
  age      45.2      45.8       -0.08    0.95      0.06    0.89
  income   58000     56500      0.12     1.08      0.09    0.45</code></pre>
<p><strong>Reading each column</strong>:</p>
<table class="table">
<colgroup>
<col width="26%">
<col width="30%">
<col width="43%">
</colgroup>
<thead><tr class="header">
<th>Column</th>
<th>Meaning</th>
<th>Good Values</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>std_diff</code></td>
<td>Standardized difference in means</td>
<td>|value| &lt; 0.1 excellent, &lt; 0.25 acceptable</td>
</tr>
<tr class="even">
<td><code>var_ratio</code></td>
<td>Ratio of standard deviations</td>
<td>0.5‚Äì2.0 acceptable, closer to 1.0 is better</td>
</tr>
<tr class="odd">
<td><code>ks_stat</code></td>
<td>Kolmogorov-Smirnov statistic</td>
<td>Smaller is better</td>
</tr>
<tr class="even">
<td><code>ks_p</code></td>
<td>KS test p-value</td>
<td>&gt; 0.05 suggests similar distributions</td>
</tr>
</tbody>
</table>
<p><strong>Quality thresholds</strong> for standardized differences:</p>
<ul>
<li>
<strong>&lt; 0.1</strong>: Excellent balance‚Äîtreat as successfully
matched</li>
<li>
<strong>0.1‚Äì0.25</strong>: Good balance‚Äîacceptable for most
purposes</li>
<li>
<strong>0.25‚Äì0.5</strong>: Marginal‚Äîconsider refinement or
sensitivity analysis</li>
<li>
<strong>&gt; 0.5</strong>: Poor balance‚Äîmatching strategy needs
revision</li>
</ul>
<p><strong>What to do if balance is poor</strong>:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Add more matching variables</strong> that explain the
imbalance</li>
<li>
<strong>Tighten calipers</strong> (accept fewer matches but better
quality)</li>
<li>
<strong>Try blocking</strong> on the problematic variable</li>
<li>
<strong>Report and discuss</strong> in limitations section</li>
</ol>
</div>
<div class="section level3">
<h3 id="visualizing-balance">Visualizing Balance<a class="anchor" aria-label="anchor" href="#visualizing-balance"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Before-after balance plot</span></span>
<span><span class="co"># (Requires creating pre-match balance for comparison)</span></span>
<span></span>
<span><span class="co"># For pre-match comparison, just compute summary statistics directly</span></span>
<span><span class="va">pre_match_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span><span class="op">)</span>,</span>
<span>  std_diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">left_data</span><span class="op">$</span><span class="va">age</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">right_data</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">left_data</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">right_data</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">left_data</span><span class="op">$</span><span class="va">income</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">right_data</span><span class="op">$</span><span class="va">income</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">left_data</span><span class="op">$</span><span class="va">income</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">right_data</span><span class="op">$</span><span class="va">income</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  when <span class="op">=</span> <span class="st">"Before"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine for plotting</span></span>
<span><span class="va">balance_comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">pre_match_stats</span>,</span>
<span>  <span class="va">balance</span><span class="op">$</span><span class="va">var_stats</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">std_diff</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>when <span class="op">=</span> <span class="st">"After"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">balance_comparison</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">variable</span>, y <span class="op">=</span> <span class="va">std_diff</span>, fill <span class="op">=</span> <span class="va">when</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Covariate Balance Before and After Matching"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Variable"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Standardized Difference"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Timing"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="matching-workflows_files/figure-html/balance-plots-1.png" class="r-plt" alt="Bar chart comparing standardized differences before and after matching, with threshold lines at 0.1 and 0.25 showing improved balance after matching" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="real-world-example-treatment-effect-estimation">Real-World Example: Treatment Effect Estimation<a class="anchor" aria-label="anchor" href="#real-world-example-treatment-effect-estimation"></a>
</h2>
<p>Complete workflow for estimating treatment effects in an
observational study.</p>
<div class="section level3">
<h3 id="scenario">Scenario<a class="anchor" aria-label="anchor" href="#scenario"></a>
</h3>
<p>Evaluate the effect of a job training program on earnings.
Participants self-selected into the program, creating potential
selection bias.</p>
<p><strong>Data:</strong> - Treatment: 200 program participants -
Control: 500 non-participants - Covariates: age, education, prior
earnings, employment status - Outcome: Earnings one year after
program</p>
</div>
<div class="section level3">
<h3 id="step-1-data-preparation">Step 1: Data Preparation<a class="anchor" aria-label="anchor" href="#step-1-data-preparation"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">404</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate realistic scenario with selection bias</span></span>
<span><span class="co"># Program attracts younger, more educated, currently employed individuals</span></span>
<span><span class="va">create_participant</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">is_treatment</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">is_treatment</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>      age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">35</span>, sd <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>      education_years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">14</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>      prior_earnings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">35000</span>, sd <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span>,</span>
<span>      employed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      treatment <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      id <span class="op">=</span> <span class="op">(</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">+</span><span class="fl">500</span><span class="op">)</span>,</span>
<span>      age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">500</span>, mean <span class="op">=</span> <span class="fl">42</span>, sd <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>      education_years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">500</span>, mean <span class="op">=</span> <span class="fl">12</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>      prior_earnings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">500</span>, mean <span class="op">=</span> <span class="fl">30000</span>, sd <span class="op">=</span> <span class="fl">12000</span><span class="op">)</span>,</span>
<span>      employed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">500</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      treatment <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">treatment_group</span> <span class="op">&lt;-</span> <span class="fu">create_participant</span><span class="op">(</span><span class="fl">200</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">control_group</span> <span class="op">&lt;-</span> <span class="fu">create_participant</span><span class="op">(</span><span class="fl">500</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate outcome (earnings) with treatment effect</span></span>
<span><span class="co"># True effect: +$5,000, with heterogeneity</span></span>
<span><span class="va">treatment_group</span> <span class="op">&lt;-</span> <span class="va">treatment_group</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    earnings <span class="op">=</span> <span class="va">prior_earnings</span> <span class="op">+</span></span>
<span>      <span class="fl">5000</span> <span class="op">+</span>  <span class="co"># True treatment effect</span></span>
<span>      <span class="fl">2000</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Random variation</span></span>
<span>      <span class="fl">100</span> <span class="op">*</span> <span class="va">education_years</span>  <span class="co"># Education effect</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">control_group</span> <span class="op">&lt;-</span> <span class="va">control_group</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    earnings <span class="op">=</span> <span class="va">prior_earnings</span> <span class="op">+</span></span>
<span>      <span class="fl">2000</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fl">100</span> <span class="op">*</span> <span class="va">education_years</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Examine baseline imbalance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Pre-matching differences:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Pre-matching differences:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Age diff:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">treatment_group</span><span class="op">$</span><span class="va">age</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">control_group</span><span class="op">$</span><span class="va">age</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Age diff: -5.525329</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Education diff:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">treatment_group</span><span class="op">$</span><span class="va">education_years</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">control_group</span><span class="op">$</span><span class="va">education_years</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Education diff: 1.801605</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Prior earnings diff:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">treatment_group</span><span class="op">$</span><span class="va">prior_earnings</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">control_group</span><span class="op">$</span><span class="va">prior_earnings</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prior earnings diff: 5420.931</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-perform-matching">Step 2: Perform Matching<a class="anchor" aria-label="anchor" href="#step-2-perform-matching"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Match on baseline covariates</span></span>
<span><span class="va">job_match</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  left <span class="op">=</span> <span class="va">treatment_group</span>,</span>
<span>  right <span class="op">=</span> <span class="va">control_group</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"education_years"</span>, <span class="st">"prior_earnings"</span>, <span class="st">"employed"</span><span class="op">)</span>,</span>
<span>  auto_scale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  scale <span class="op">=</span> <span class="st">"robust"</span>,</span>
<span>  return_diagnostics <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matching summary:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Matching summary:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Treated units:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">treatment_group</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Treated units: 200</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Matched treated:"</span>, <span class="va">job_match</span><span class="op">$</span><span class="va">info</span><span class="op">$</span><span class="va">n_matched</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Matched treated: 200</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Match rate:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">job_match</span><span class="op">$</span><span class="va">info</span><span class="op">$</span><span class="va">n_matched</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">treatment_group</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Match rate: 100 %</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-assess-balance">Step 3: Assess Balance<a class="anchor" aria-label="anchor" href="#step-3-assess-balance"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract matched samples</span></span>
<span><span class="va">matched_treated</span> <span class="op">&lt;-</span> <span class="va">treatment_group</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">job_match</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">left_id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">matched_control</span> <span class="op">&lt;-</span> <span class="va">control_group</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">job_match</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">right_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute balance</span></span>
<span><span class="va">job_balance</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/balance_diagnostics.html">balance_diagnostics</a></span><span class="op">(</span></span>
<span>  result <span class="op">=</span> <span class="va">job_match</span>,</span>
<span>  left <span class="op">=</span> <span class="va">treatment_group</span>,</span>
<span>  right <span class="op">=</span> <span class="va">control_group</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"education_years"</span>, <span class="st">"prior_earnings"</span>, <span class="st">"employed"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in ks.test.default(left_clean, right_clean): p-value will be</span></span>
<span><span class="co">#&gt; approximate in the presence of ties</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">job_balance</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Balance Diagnostics for Matched Pairs</span></span>
<span><span class="co">#&gt; ======================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matching Summary:</span></span>
<span><span class="co">#&gt;   Method: lap</span></span>
<span><span class="co">#&gt;   Matched pairs: 200</span></span>
<span><span class="co">#&gt;   Unmatched left: 0 (of 200)</span></span>
<span><span class="co">#&gt;   Unmatched right: 300 (of 500)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable-level Balance:</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 √ó 7</span></span></span>
<span><span class="co">#&gt;   Variable `Mean Left` `Mean Right` `Mean Diff` `Std Diff` `Var Ratio` `KS Stat`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> age             35.4       36.0        -<span style="color: #BB0000;">0.656</span>     -<span style="color: #BB0000;">0.081</span>       0.869     0.1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> educati‚Ä¶        13.9       13.5         0.4        0.195       0.93      0.18 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> prior_e‚Ä¶     <span style="text-decoration: underline;">35</span>015.     <span style="text-decoration: underline;">33</span>795.       <span style="text-decoration: underline;">1</span>219.         0.121       1.01      0.08 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> employed         0.7        0.635       0.065      0.138       0.952     0.065</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall Balance:</span></span>
<span><span class="co">#&gt;   Mean |Std Diff|: 0.134 (Good)</span></span>
<span><span class="co">#&gt;   Max |Std Diff|: 0.195</span></span>
<span><span class="co">#&gt;   Vars with |Std Diff| &gt; 0.25: 0.0%</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Balance Interpretation:</span></span>
<span><span class="co">#&gt;   |Std Diff| &lt; 0.10: Excellent balance</span></span>
<span><span class="co">#&gt;   |Std Diff| 0.10-0.25: Good balance</span></span>
<span><span class="co">#&gt;   |Std Diff| 0.25-0.50: Acceptable balance</span></span>
<span><span class="co">#&gt;   |Std Diff| &gt; 0.50: Poor balance</span></span>
<span></span>
<span><span class="co"># Check overall balance quality</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nOverall balance:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall balance:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Mean |std diff|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">job_balance</span><span class="op">$</span><span class="va">overall</span><span class="op">$</span><span class="va">mean_abs_std_diff</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Mean |std diff|: 0.134</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Max |std diff|:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">job_balance</span><span class="op">$</span><span class="va">overall</span><span class="op">$</span><span class="va">max_abs_std_diff</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Max |std diff|: 0.195</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  % with |std diff| &gt; 0.1:"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">job_balance</span><span class="op">$</span><span class="va">overall</span><span class="op">$</span><span class="va">pct_large_imbalance</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   % with |std diff| &gt; 0.1: 0 %</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-4-estimate-treatment-effect">Step 4: Estimate Treatment Effect<a class="anchor" aria-label="anchor" href="#step-4-estimate-treatment-effect"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Naive estimate (without matching) - BIASED</span></span>
<span><span class="va">naive_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">treatment_group</span><span class="op">$</span><span class="va">earnings</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">control_group</span><span class="op">$</span><span class="va">earnings</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Matched estimate - accounts for baseline differences</span></span>
<span><span class="va">matched_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">matched_treated</span><span class="op">$</span><span class="va">earnings</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">matched_control</span><span class="op">$</span><span class="va">earnings</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Paired t-test for significance</span></span>
<span><span class="va">paired_comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  treated <span class="op">=</span> <span class="va">matched_treated</span><span class="op">$</span><span class="va">earnings</span>,</span>
<span>  control <span class="op">=</span> <span class="va">matched_control</span><span class="op">$</span><span class="va">earnings</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span></span>
<span>    <span class="va">matched_treated</span><span class="op">$</span><span class="va">id</span>,</span>
<span>    <span class="va">job_match</span><span class="op">$</span><span class="va">pairs</span><span class="op">$</span><span class="va">left_id</span></span>
<span>  <span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">t_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html" class="external-link">t.test</a></span><span class="op">(</span><span class="va">paired_comparison</span><span class="op">$</span><span class="va">treated</span>, <span class="va">paired_comparison</span><span class="op">$</span><span class="va">control</span>, paired <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Report results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Treatment Effect Estimates:\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Treatment Effect Estimates:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Naive (unmatched):\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Naive (unmatched):</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Difference: $"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">naive_effect</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Difference: $ 10680</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  (Upward biased due to selection)\n\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   (Upward biased due to selection)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matched estimate:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Matched estimate:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Difference: $"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">matched_effect</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Difference: $ 6276</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  95% CI: ($"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">t_test</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">", $"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">t_test</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span>, <span class="st">")\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   95% CI: ($ 4301 , $ 8252 )</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  P-value:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.pval.html" class="external-link">format.pval</a></span><span class="op">(</span><span class="va">t_test</span><span class="op">$</span><span class="va">p.value</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   P-value: 2.26e-09</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  (Closer to true effect of $5,000)\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   (Closer to true effect of $5,000)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-5-publication-ready-output">Step 5: Publication-Ready Output<a class="anchor" aria-label="anchor" href="#step-5-publication-ready-output"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Table 1: Balance table</span></span>
<span><span class="va">balance_publication</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/balance_table.html">balance_table</a></span><span class="op">(</span><span class="va">job_balance</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">balance_publication</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Table 2: Sample characteristics</span></span>
<span><span class="va">sample_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">matched_treated</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>      Group <span class="op">=</span> <span class="st">"Treatment"</span>,</span>
<span>      N <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      `Age (mean ¬± SD)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f ¬± %.1f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      `Education (years)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f ¬± %.1f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">education_years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">education_years</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      `Prior Earnings` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"$%s ¬± %s"</span>,</span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">prior_earnings</span><span class="op">)</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>,</span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">prior_earnings</span><span class="op">)</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      `Employed (%)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">employed</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="va">matched_control</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>      Group <span class="op">=</span> <span class="st">"Control"</span>,</span>
<span>      N <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      `Age (mean ¬± SD)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f ¬± %.1f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      `Education (years)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f ¬± %.1f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">education_years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">education_years</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      `Prior Earnings` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"$%s ¬± %s"</span>,</span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">prior_earnings</span><span class="op">)</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>,</span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">prior_earnings</span><span class="op">)</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      `Employed (%)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">employed</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sample_table</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Table 3: Treatment effect</span></span>
<span><span class="va">effect_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  Method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Unmatched"</span>, <span class="st">"Matched"</span><span class="op">)</span>,</span>
<span>  `N (Treated)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">treatment_group</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">matched_treated</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  `N (Control)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">control_group</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">matched_control</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  `Effect Estimate` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"$%s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">naive_effect</span>, <span class="va">matched_effect</span><span class="op">)</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  `95% CI` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"--"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"($%s, $%s)"</span>,</span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">t_test</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>,</span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">t_test</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">effect_table</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="performance-considerations">Performance Considerations<a class="anchor" aria-label="anchor" href="#performance-considerations"></a>
</h2>
<div class="section level3">
<h3 id="scalability">Scalability<a class="anchor" aria-label="anchor" href="#scalability"></a>
</h3>
<p><strong>Optimal matching complexity:</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false" form="prefix">(</mo><msup><mi>n</mi><mn>3</mn></msup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">O(n^3)</annotation></semantics></math>
using Jonker-Volgenant</p>
<ul>
<li>n = 100: &lt; 0.01 seconds</li>
<li>n = 500: ~ 0.1 seconds</li>
<li>n = 1,000: ~ 1 second</li>
<li>n = 3,000: ~ 10 seconds</li>
<li>n = 5,000: ~ 30-60 seconds</li>
</ul>
<p><strong>Greedy matching complexity:</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false" form="prefix">(</mo><msup><mi>n</mi><mn>2</mn></msup><mrow><mi mathvariant="normal">log</mi><mo>‚Å°</mo></mrow><mi>n</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">O(n^2 \log n)</annotation></semantics></math>
for sorted,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false" form="prefix">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math>
for row-best</p>
<ul>
<li>n = 5,000: ~ 1 second</li>
<li>n = 10,000: ~ 3-5 seconds</li>
<li>n = 50,000: ~ 30-60 seconds</li>
</ul>
</div>
<div class="section level3">
<h3 id="memory-usage">Memory Usage<a class="anchor" aria-label="anchor" href="#memory-usage"></a>
</h3>
<ul>
<li>Cost matrix: 8n¬≤ bytes (for n√ón problem)</li>
<li>n = 1,000: ~ 8 MB</li>
<li>n = 5,000: ~ 200 MB</li>
<li>n = 10,000: ~ 800 MB</li>
</ul>
<p>For very large problems:</p>
<ol style="list-style-type: decimal">
<li>Use greedy matching to avoid full cost matrix</li>
<li>Use blocking to reduce within-block size</li>
<li>Consider approximate methods (upcoming vignette)</li>
</ol>
</div>
<div class="section level3">
<h3 id="optimization-tips">Optimization Tips<a class="anchor" aria-label="anchor" href="#optimization-tips"></a>
</h3>
<p><strong>1. Use blocking for large datasets</strong></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Instead of matching 10,000 √ó 10,000:</span></span>
<span><span class="co"># Create 10 blocks of ~1,000 √ó 1,000 each</span></span>
<span><span class="va">blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchmaker.html">matchmaker</a></span><span class="op">(</span></span>
<span>  <span class="va">left_large</span>, <span class="va">right_large</span>,</span>
<span>  block_type <span class="op">=</span> <span class="st">"cluster"</span>,</span>
<span>  cluster_vars <span class="op">=</span> <span class="st">"age"</span>,</span>
<span>  n_clusters <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Much faster: 10 * O(1000^3) &lt;&lt; O(10000^3)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">blocks</span><span class="op">$</span><span class="va">left</span>, <span class="va">blocks</span><span class="op">$</span><span class="va">right</span>,</span>
<span>  vars <span class="op">=</span> <span class="va">covariates</span>,</span>
<span>  block_id <span class="op">=</span> <span class="st">"block_id"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>2. Start with greedy, refine if needed</strong></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Quick greedy match for exploration</span></span>
<span><span class="va">quick</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/greedy_couples.html">greedy_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">left_data</span>, <span class="va">right_data</span>,</span>
<span>  vars <span class="op">=</span> <span class="va">covariates</span>,</span>
<span>  strategy <span class="op">=</span> <span class="st">"row_best"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assess balance</span></span>
<span><span class="va">balance_quick</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/balance_diagnostics.html">balance_diagnostics</a></span><span class="op">(</span><span class="va">quick</span>, <span class="va">left_data</span>, <span class="va">right_data</span>, vars <span class="op">=</span> <span class="va">covariates</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># If balance is acceptable, done!</span></span>
<span><span class="co"># If not, try optimal or add blocking</span></span></code></pre></div>
<p><strong>3. Use calipers to reduce problem size</strong></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Caliper removes distant pairs from cost matrix</span></span>
<span><span class="co"># Can dramatically reduce effective problem size</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span></span>
<span>  <span class="va">left_data</span>, <span class="va">right_data</span>,</span>
<span>  vars <span class="op">=</span> <span class="va">covariates</span>,</span>
<span>  max_distance <span class="op">=</span> <span class="fl">0.25</span>,  <span class="co"># Strict caliper</span></span>
<span>  auto_scale <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="what-can-go-wrong">What Can Go Wrong<a class="anchor" aria-label="anchor" href="#what-can-go-wrong"></a>
</h2>
<p>Matching doesn‚Äôt always succeed. Here are common problems and
solutions.</p>
<div class="section level3">
<h3 id="problem-poor-balance-despite-matching">Problem: Poor Balance Despite Matching<a class="anchor" aria-label="anchor" href="#problem-poor-balance-despite-matching"></a>
</h3>
<p><strong>Symptom</strong>: <code><a href="../reference/balance_diagnostics.html">balance_diagnostics()</a></code> shows
|std_diff| &gt; 0.25 for some variables.</p>
<p><strong>Causes</strong>: - Groups are fundamentally too different
(weak overlap) - Important confounders not included in matching
variables - Caliper too loose</p>
<p><strong>Solutions</strong>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Add more matching variables</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span>,</span>
<span>                        vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"income"</span>, <span class="st">"education"</span>, <span class="st">"region"</span><span class="op">)</span>,  <span class="co"># Added!</span></span>
<span>                        auto_scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Tighten caliper (fewer but better matches)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span>, vars <span class="op">=</span> <span class="va">vars</span>,</span>
<span>                        max_distance <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>  <span class="co"># Was 0.5</span></span>
<span></span>
<span><span class="co"># 3. Block on the problematic variable</span></span>
<span><span class="va">blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchmaker.html">matchmaker</a></span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span>, block_type <span class="op">=</span> <span class="st">"group"</span>, block_by <span class="op">=</span> <span class="st">"region"</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">$</span><span class="va">left</span>, <span class="va">blocks</span><span class="op">$</span><span class="va">right</span>, vars <span class="op">=</span> <span class="va">other_vars</span>,</span>
<span>                        block_id <span class="op">=</span> <span class="st">"block_id"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="problem-very-few-matches">Problem: Very Few Matches<a class="anchor" aria-label="anchor" href="#problem-very-few-matches"></a>
</h3>
<p><strong>Symptom</strong>: <code>n_matched</code> is much smaller than
<code>nrow(left)</code>.</p>
<p><strong>Causes</strong>: - Caliper too strict - Non-overlapping
covariate distributions - Blocking creates small strata</p>
<p><strong>Diagnosis</strong>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check covariate overlap</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">left</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="st">"treatment"</span><span class="op">)</span>,</span>
<span>  <span class="va">right</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="st">"control"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">combined</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, fill <span class="op">=</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Check for Overlap"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Solutions</strong>: - Relax caliper - Use coarser blocking
categories - Accept that some treatment units are unmatchable (report
this!)</p>
</div>
<div class="section level3">
<h3 id="problem-matching-takes-too-long">Problem: Matching Takes Too Long<a class="anchor" aria-label="anchor" href="#problem-matching-takes-too-long"></a>
</h3>
<p><strong>Symptom</strong>: <code><a href="../reference/match_couples.html">match_couples()</a></code> runs for
minutes or doesn‚Äôt complete. <strong>Cause</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false" form="prefix">(</mo><msup><mi>n</mi><mn>3</mn></msup><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">O(n^3)</annotation></semantics></math>
complexity for optimal matching.</p>
<p><strong>Solutions</strong>:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For n &gt; 3000: use greedy</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/greedy_couples.html">greedy_couples</a></span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span>, vars <span class="op">=</span> <span class="va">vars</span>, strategy <span class="op">=</span> <span class="st">"sorted"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For n &gt; 5000: add blocking</span></span>
<span><span class="va">blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchmaker.html">matchmaker</a></span><span class="op">(</span><span class="va">left</span>, <span class="va">right</span>, block_type <span class="op">=</span> <span class="st">"cluster"</span>, n_blocks <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_couples.html">match_couples</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">$</span><span class="va">left</span>, <span class="va">blocks</span><span class="op">$</span><span class="va">right</span>, vars <span class="op">=</span> <span class="va">vars</span>,</span>
<span>                        block_id <span class="op">=</span> <span class="st">"block_id"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="problem-memory-error">Problem: Memory Error<a class="anchor" aria-label="anchor" href="#problem-memory-error"></a>
</h3>
<p><strong>Symptom</strong>: R crashes or reports ‚Äúcannot allocate
vector of size X‚Äù.</p>
<p><strong>Cause</strong>: Full cost matrix doesn‚Äôt fit in RAM. A
10,000√ó10,000 matrix needs ~800 MB.</p>
<p><strong>Solutions</strong>: - Use <code><a href="../reference/greedy_couples.html">greedy_couples()</a></code> which
doesn‚Äôt require full matrix - Use blocking to create smaller
sub-problems - Consider random sampling if sample size permits</p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This vignette walked through a complete matching workflow using the
job training evaluation example:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Problem framing</strong>: Treatment effect estimation with
selection bias</li>
<li>
<strong>Matching</strong>: Creating comparable groups with
<code><a href="../reference/match_couples.html">match_couples()</a></code>
</li>
<li>
<strong>Preprocessing</strong>: Automatic scaling and variable
health checks</li>
<li>
<strong>Assessment</strong>: Balance diagnostics and
interpretation</li>
<li>
<strong>Refinement</strong>: Calipers, blocking, and greedy
alternatives</li>
<li>
<strong>Estimation</strong>: Treatment effect with confidence
intervals</li>
</ol>
<p><strong>Key Takeaways</strong>:</p>
<table class="table">
<colgroup>
<col width="45%">
<col width="55%">
</colgroup>
<thead><tr class="header">
<th>Concept</th>
<th>Key Point</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Preprocessing</td>
<td>Always use <code>auto_scale = TRUE</code> unless you have a specific
reason not to</td>
</tr>
<tr class="even">
<td>Balance</td>
<td>Target |std_diff| &lt; 0.1; accept &lt; 0.25</td>
</tr>
<tr class="odd">
<td>Calipers</td>
<td>Start loose, tighten if needed for balance</td>
</tr>
<tr class="even">
<td>Blocking</td>
<td>Use for exact balance on key categorical variables</td>
</tr>
<tr class="odd">
<td>Greedy</td>
<td>Use for n &gt; 3000; almost as good, much faster</td>
</tr>
</tbody>
</table>
<p><strong>Recommended Workflow</strong>:</p>
<pre><code>1. Explore data ‚Üí Identify confounders
                      ‚Üì
2. First match   ‚Üí match_couples(vars, auto_scale = TRUE)
                      ‚Üì
3. Check balance ‚Üí balance_diagnostics()
                      ‚Üì
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    Balance OK                   Balance poor
       ‚Üì                              ‚Üì
4. Estimate effect             Refine: caliper, blocking,
                               more variables
                                      ‚Üì
                               Return to step 3</code></pre>
<p><strong>What‚Äôs Next?</strong></p>
<table class="table">
<colgroup>
<col width="67%">
<col width="32%">
</colgroup>
<thead><tr class="header">
<th>If you want to‚Ä¶</th>
<th>Read‚Ä¶</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Understand LAP algorithms</td>
<td><code><a href="../articles/algorithms.html">vignette("algorithms")</a></code></td>
</tr>
<tr class="even">
<td>Handle very large n (&gt; 10,000)</td>
<td>
<code><a href="../articles/pixel-morphing.html">vignette("pixel-morphing")</a></code> for approximation
strategies</td>
</tr>
<tr class="odd">
<td>Learn basic assignment</td>
<td><code><a href="../articles/getting-started.html">vignette("getting-started")</a></code></td>
</tr>
</tbody>
</table>
<p><strong>Function reference</strong>: <code><a href="../reference/match_couples.html">?match_couples</a></code>,
<code><a href="../reference/greedy_couples.html">?greedy_couples</a></code>, <code><a href="../reference/balance_diagnostics.html">?balance_diagnostics</a></code>,
<code><a href="../reference/matchmaker.html">?matchmaker</a></code></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by First Last.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
