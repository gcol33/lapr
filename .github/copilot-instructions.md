<!-- Copilot / AI agent instructions for the `lapr` codebase -->

# Quick Orientation

This repository is an R package (`lapr`) that provides linear-assignment solvers and image "pixel morphing" helpers. The project mixes R (high-level API, data handling, vignettes/tests) and C++ (many solver implementations, Rcpp exports, image routines).

Key design points AI agents should know:
- R is the user-facing API: see `R/assignment.R` (method selection) and `R/lap_solve.R` (tidy wrappers).
- C++ implements algorithms: look in `src/` (many `solve_*.cpp`) and the unified interface in `src/rcpp_interface.cpp`.
- Exported C++ functions use the `lap_` prefix (e.g. `lap_solve_jv`, `lap_solve_hungarian`) and are called from R via generated `RcppExports.R`.
- Image/pixel utilities are implemented in C++ and called from R (see `R/pixel_morph.R` and exports in `rcpp_interface.cpp`).

# Files to reference when making changes
- `R/assignment.R` — central auto-selection logic and the `assignment()` wrapper. Add new solver names here.
- `R/lap_solve.R` — tidy user-facing functions, grouped-data handling and printing conventions.
- `src/rcpp_interface.cpp` — declare/export C++ entry points. New C++ solver impls must be exposed here.
- `src/solve_*.cpp` — algorithm implementations (one file per solver).
- `R/RcppExports.R` — autogenerated wrappers (.Call). Do not edit manually; regenerate via `Rcpp::compileAttributes()` when adding exports.
- `DESCRIPTION` — package metadata, imports (`Rcpp`, `RcppEigen`) and `SystemRequirements: C++17`.

# Build / test / debug workflows (Windows notes)
- Prerequisites: R (see `DESCRIPTION`), dev packages (`Rcpp`, `RcppEigen`, `devtools`/`remotes`) and a C++ toolchain (Rtools on Windows) supporting C++17.
- Typical local build/install (from package root):
  - In a normal shell / Powershell: `R CMD INSTALL --build .`
  - In R: `devtools::install(build = TRUE)` (requires `devtools`).
- Run checks / tests:
  - `R CMD build .` then `R CMD check <tarball>`
  - In R: `devtools::check()` and `devtools::test()` (uses testthat, parallel configured in DESCRIPTION).
- If you encounter strange binary mismatches, remove committed build artefacts before reinstalling: `Remove-Item src\*.o, src\*.dll -Force` (Powershell) or simply run `R CMD INSTALL --clean .`.

# Conventions & patterns to follow
- Naming: R-facing solver wrappers use `lap_solve_<name>` in C++ and `method` strings in R map to these via `assignment()` (see `switch()` in `R/assignment.R`).
- 0/1-based indexing: R uses 1-based assignment vectors; many C++ internals use 0-based. Conversions happen in `RcppExports.R` / `rcpp_interface.cpp` — preserve those conversions.
- Forbidden edges: `NA` or `Inf` in the cost matrix marks forbidden assignments. `assignment()` converts inputs and relies on `prepare_cost_matrix` in C++ for masking.
- Adding a new C++ solver:
  1. Add `src/solve_<name>.cpp` implementing the algorithm.
  2. Declare an `impl` function prototype in `src/rcpp_interface.cpp` and implement an exported wrapper with `// [[Rcpp::export]]` named `lap_solve_<name>`.
  3. Run `Rcpp::compileAttributes()` (regenerates `R/RcppExports.R` and `src/RcppExports.cpp`).
  4. Wire the method string into `R/assignment.R`'s `switch()` and add documentation.

# Pixel morph specifics
- `R/pixel_morph.R` orchestrates pixel-level operations and calls several C++ helpers (e.g. `compute_pixel_cost_cpp`, `morph_pixel_level_cpp`).
- C++ image exports expect vectors of length `H * W * 3` and perform strict validation; keep argument shapes and type checks when modifying these paths.
- Assignment semantics: during rendering C++ expects 0-based assignment indices; R returns 1-based vectors to callers. Check conversions around `assign_0based + 1L` in `R/pixel_morph.R`.

# Dependencies & environment
- Declared in `DESCRIPTION`: `Rcpp`, `RcppEigen`, `tibble`, `dplyr`, `rlang`, `purrr`, `magrittr`, and many Suggests (testthat, knitr, magick...). Ensure required system libs and Rtools (Windows) are available for compilation.

# Common pitfalls to avoid
- Do not manually edit auto-generated files: `R/RcppExports.R` and `src/RcppExports.cpp` are created by `Rcpp::compileAttributes()`.
- The `src/` directory contains committed object files (`*.o`, `*.dll`); they can be stale. Clean before building if behavior is unexpected.
- Keep `method` strings in `R/assignment.R` and exported `lap_` C++ names in sync.

# Example quick tasks for an AI code agent
- Add a new solver: follow the "Adding a new C++ solver" steps above and add documentation in `man/` via roxygen comments.
- Improve auto-selection heuristics: modify `R/assignment.R::method == 'auto'` heuristics and add tests under `tests/` demonstrating expected selection for small/sparse/dense inputs.

# Contact / Issues
- Bug reports URL in `DESCRIPTION`: `https://gitlab.com/lenznerb28/assignR/-/issues` — open an issue for ambiguous design decisions.

Please review and tell me what to clarify or expand (specific files, more examples, or CI instructions). 
